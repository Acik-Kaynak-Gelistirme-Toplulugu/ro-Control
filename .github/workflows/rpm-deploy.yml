name: RPM Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to deploy (example: v1.1.0)"
        required: true
        default: "v1.1.0"

concurrency:
  group: rpm-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  DNF_DEPS: >-
    cmake gcc-c++ pkgconf-pkg-config
    qt6-qtbase-devel qt6-qtdeclarative-devel qt6-qtwayland-devel
    kf6-qqc2-desktop-style

jobs:
  build-rpm:
    name: Build RPM
    runs-on: ubuntu-latest
    container: fedora:42
    outputs:
      version: ${{ steps.meta.outputs.version }}
      rpm_name: ${{ steps.meta.outputs.rpm_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || inputs.release_tag || github.ref }}

      - name: Resolve version metadata
        id: meta
        run: |
          set -euo pipefail
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "rpm_name=ro-control-${VERSION}-1.fc42.x86_64.rpm" >> "$GITHUB_OUTPUT"
          echo "Building ro-control v${VERSION}"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.100.0

      - name: Install build dependencies
        run: dnf install -y git extra-cmake-modules rpm-build createrepo_c $DNF_DEPS

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-rpm-deploy-${{ hashFiles('**/Cargo.lock') }}

      - name: Build RPM package
        run: |
          set -euo pipefail
          VERSION="${{ steps.meta.outputs.version }}"
          TOPDIR="$PWD/rpmbuild"

          mkdir -p "$TOPDIR"/{SOURCES,SPECS,RPMS,SRPMS,BUILD,BUILDROOT}
          cp packaging/rpm/ro-control.spec "$TOPDIR/SPECS/"

          # Create source tarball
          tar -czf "$TOPDIR/SOURCES/ro-control-${VERSION}.tar.gz" \
            --exclude-vcs \
            --exclude='./target' \
            --exclude='./rpmbuild' \
            --transform "s,^\./,ro-control-${VERSION}/," \
            .

          # Build binary + source RPM
          rpmbuild -ba --nodeps "$TOPDIR/SPECS/ro-control.spec" \
            --define "_topdir $TOPDIR" \
            --define "_sourcedir $TOPDIR/SOURCES" \
            --define "_rpmdir $TOPDIR/RPMS" \
            --define "_srcrpmdir $TOPDIR/SRPMS"

      - name: Verify RPM was built
        run: |
          set -euo pipefail
          RPM_FILE=$(find rpmbuild/RPMS -name '*.x86_64.rpm' | head -1)
          SRPM_FILE=$(find rpmbuild/SRPMS -name '*.src.rpm' | head -1)
          if [ -z "$RPM_FILE" ]; then
            echo "ERROR: No x86_64 RPM found!"
            exit 1
          fi
          echo "Built RPM: $RPM_FILE"
          echo "Built SRPM: $SRPM_FILE"
          rpm -qip "$RPM_FILE"

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages
          path: |
            rpmbuild/RPMS/**/*.x86_64.rpm
            rpmbuild/SRPMS/*.src.rpm
          retention-days: 30

  deploy-repo:
    name: Deploy to ro-repo
    runs-on: ubuntu-latest
    needs: build-rpm
    steps:
      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-packages

      - name: Find RPM files
        id: rpms
        run: |
          set -euo pipefail
          echo "--- Downloaded artifacts ---"
          find . -name '*.rpm' -type f
          RPM_FILE=$(find . -name '*.x86_64.rpm' -type f | head -1)
          SRPM_FILE=$(find . -name '*.src.rpm' -type f | head -1)
          echo "rpm_file=$RPM_FILE" >> "$GITHUB_OUTPUT"
          echo "srpm_file=$SRPM_FILE" >> "$GITHUB_OUTPUT"

      - name: Clone ro-repo
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${{ secrets.REPO_TOKEN }}@github.com/Acik-Kaynak-Gelistirme-Toplulugu/ro-repo.git" ro-repo

      - name: Deploy RPM to repository
        run: |
          set -euo pipefail
          cd ro-repo

          # Create directory structure if needed
          mkdir -p packages/ro-control

          # Copy RPM(s) into the repo
          cp "${{ steps.rpms.outputs.rpm_file }}" packages/ro-control/
          if [ -n "${{ steps.rpms.outputs.srpm_file }}" ]; then
            mkdir -p source/ro-control
            cp "${{ steps.rpms.outputs.srpm_file }}" source/ro-control/
          fi

      - name: Regenerate repo metadata
        run: |
          set -euo pipefail
          sudo apt-get update -qq && sudo apt-get install -y -qq createrepo-c
          cd ro-repo

          # Generate/update repodata for binary packages
          if [ -d packages ]; then
            createrepo_c --update packages/
          fi

          # Generate/update repodata for source packages
          if [ -d source ]; then
            createrepo_c --update source/
          fi

      - name: Commit and push
        run: |
          set -euo pipefail
          cd ro-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy"
            exit 0
          fi

          VERSION="${{ needs.build-rpm.outputs.version }}"
          git commit -m "deploy: ro-control v${VERSION} RPM"
          git push origin main
