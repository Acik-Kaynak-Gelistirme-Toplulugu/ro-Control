name: RPM Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to deploy (example: v1.2.0)"
        required: true
        default: "v1.2.0"

concurrency:
  group: rpm-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  DNF_DEPS: >-
    cmake gcc-c++ pkgconf-pkg-config
    qt6-qtbase-devel qt6-qtdeclarative-devel qt6-qtwayland-devel
    kf6-qqc2-desktop-style

jobs:
  # ── Stage 1: Build RPM inside Fedora 42 container ──────────────────
  build-rpm:
    name: Build RPM
    runs-on: ubuntu-latest
    container: fedora:42
    outputs:
      version: ${{ steps.meta.outputs.version }}
      rpm_name: ${{ steps.meta.outputs.rpm_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || inputs.release_tag || github.ref }}

      - name: Resolve version metadata
        id: meta
        run: |
          set -euo pipefail
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          echo "version=$VERSION"   >> "$GITHUB_OUTPUT"
          echo "rpm_name=ro-control-${VERSION}-1.fc42.x86_64.rpm" >> "$GITHUB_OUTPUT"
          echo "::notice::Building ro-control v${VERSION}"

      # Keep spec Version in sync with Cargo.toml automatically
      - name: Sync spec version
        run: |
          set -euo pipefail
          VERSION="${{ steps.meta.outputs.version }}"
          sed -i "s/^Version:.*/Version:        ${VERSION}/" packaging/rpm/ro-control.spec
          grep '^Version:' packaging/rpm/ro-control.spec

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.88.0

      - name: Install build dependencies
        run: dnf install -y --setopt=retries=5 git extra-cmake-modules rpm-build $DNF_DEPS

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-rpm-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build RPM package
        run: |
          set -euo pipefail
          VERSION="${{ steps.meta.outputs.version }}"
          TOPDIR="$PWD/rpmbuild"

          mkdir -p "$TOPDIR"/{SOURCES,SPECS,RPMS,SRPMS,BUILD,BUILDROOT}
          cp packaging/rpm/ro-control.spec "$TOPDIR/SPECS/"

          # Source tarball – directory inside must match %autosetup -n
          tar -czf "$TOPDIR/SOURCES/ro-control-${VERSION}.tar.gz" \
            --exclude-vcs \
            --exclude='./target' \
            --exclude='./rpmbuild' \
            --transform "s,^\./,ro-control-${VERSION}/," \
            .

          rpmbuild -ba --nodeps "$TOPDIR/SPECS/ro-control.spec" \
            --define "_topdir $TOPDIR" \
            --define "_sourcedir $TOPDIR/SOURCES" \
            --define "_rpmdir $TOPDIR/RPMS" \
            --define "_srcrpmdir $TOPDIR/SRPMS"

      - name: Verify RPM
        run: |
          set -euo pipefail
          RPM_FILE=$(find rpmbuild/RPMS -name '*.x86_64.rpm' | head -1)
          if [ -z "$RPM_FILE" ]; then
            echo "::error::No x86_64 RPM found!"
            exit 1
          fi
          echo "::notice::Built $RPM_FILE ($(du -h "$RPM_FILE" | cut -f1))"
          rpm -qip "$RPM_FILE"
          echo "--- Included files ---"
          rpm -qlp "$RPM_FILE"

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages
          path: |
            rpmbuild/RPMS/**/*.x86_64.rpm
            rpmbuild/SRPMS/*.src.rpm
          retention-days: 90

  # ── Stage 2: Publish to DNF repository (ro-repo) ──────────────────
  deploy-repo:
    name: Deploy to ro-repo
    runs-on: ubuntu-latest
    needs: build-rpm
    permissions:
      contents: read
    steps:
      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-packages

      - name: Locate RPM files
        id: rpms
        run: |
          set -euo pipefail
          echo "--- Downloaded artifacts ---"
          find . -name '*.rpm' -type f
          RPM_FILE=$(find . -name '*.x86_64.rpm' -type f | head -1)
          SRPM_FILE=$(find . -name '*.src.rpm' -type f | head -1)
          if [ -z "$RPM_FILE" ]; then
            echo "::error::No RPM artifact found!"
            exit 1
          fi
          echo "rpm_file=$RPM_FILE"          >> "$GITHUB_OUTPUT"
          echo "srpm_file=${SRPM_FILE:-}"     >> "$GITHUB_OUTPUT"

      - name: Install createrepo-c
        run: sudo apt-get update -qq && sudo apt-get install -y -qq createrepo-c

      - name: Clone ro-repo
        run: |
          git clone "https://x-access-token:${{ secrets.REPO_TOKEN }}@github.com/Acik-Kaynak-Gelistirme-Toplulugu/ro-repo.git" ro-repo

      - name: Deploy RPM packages
        run: |
          set -euo pipefail
          VERSION="${{ needs.build-rpm.outputs.version }}"
          cd ro-repo

          # ── Binary RPMs ──
          mkdir -p packages
          # Remove previous versions of ro-control to keep repo lean
          find packages/ -name 'ro-control-*.rpm' -delete 2>/dev/null || true
          cp "$GITHUB_WORKSPACE/${{ steps.rpms.outputs.rpm_file }}" packages/

          # ── Source RPMs ──
          SRPM="${{ steps.rpms.outputs.srpm_file }}"
          if [ -n "$SRPM" ]; then
            mkdir -p source
            find source/ -name 'ro-control-*.rpm' -delete 2>/dev/null || true
            cp "$GITHUB_WORKSPACE/$SRPM" source/
          fi

          # ── Repo metadata ──
          createrepo_c --update packages/
          if [ -d source ]; then
            createrepo_c --update source/
          fi

          # ── DNF .repo config (users download this to add the repo) ──
          cat > ro-control.repo << 'EOF'
          [ro-control]
          name=ro-Control - Smart GPU Driver Manager
          baseurl=https://raw.githubusercontent.com/Acik-Kaynak-Gelistirme-Toplulugu/ro-repo/main/packages
          enabled=1
          gpgcheck=0
          metadata_expire=12h
          EOF
          sed -i 's/^          //' ro-control.repo

      - name: Commit and push
        run: |
          set -euo pipefail
          cd ro-repo
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "::notice::No changes to deploy"
            exit 0
          fi

          VERSION="${{ needs.build-rpm.outputs.version }}"
          git commit -m "deploy: ro-control v${VERSION} RPM"
          git push origin main
