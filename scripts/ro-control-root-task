#!/bin/bash
# ro-Control — Privileged Task Wrapper
# Invoked by PolicyKit (pkexec) to run commands as root.
# See: data/polkit/io.github.AcikKaynakGelistirmeToplulugu.ro-control.policy
#
# Usage: ro-control-root-task "cmd1" "cmd2" "cmd3"
#   Each argument is a single command. They are executed sequentially.
#   If any command fails, execution stops and the exit code is propagated.
#
# SECURITY: Only commands matching the allowlist are executed.
# Shell metacharacters are rejected BEFORE allowlist matching.

set -uo pipefail
export LC_ALL=C

if [ $# -eq 0 ]; then
    printf '%s\n' "Error: No command provided." >&2
    exit 1
fi

# ─── Dangerous Characters / Patterns ────────────────────────────
# Reject ANY argument containing shell metacharacters that could
# bypass the allowlist via subshells, pipes, redirection, etc.
DANGEROUS_PATTERNS=(
    '&'       # background / chaining (&, &&)
    '|'       # pipe / or (|, ||)
    ';'       # command separator
    '`'       # backtick subshell
    '$('      # subshell expansion
    '${'      # variable expansion
    '>>'      # append redirect
    '2>'      # stderr redirect
    '<('      # process substitution
    '>('      # process substitution
    '>'       # stdout redirect (catch-all)
    '"'       # double quote injection
    "'"       # single quote injection
    '\'       # backslash escape
    $'\n'     # newline injection
)

# ─── Command Allowlist ───────────────────────────────────────────
# Only these command prefixes are permitted to run as root.
# Each entry is a regex anchored to the start of the command string.
ALLOWED_COMMANDS=(
    "^dnf "
    "^rpm "
    "^apt-get "
    "^pacman "
    "^zypper "
    "^dracut "
    "^mkinitcpio "
    "^mkinitrd "
    "^update-initramfs "
    "^modprobe "
    "^grubby "
    "^grub2-mkconfig "
    "^update-grub"
    "^sed -i .*/etc/modprobe\.d/"
    "^sed -i .*/etc/default/grub$"
    "^cp /etc/X11/.* /etc/X11/"
    "^cp /etc/default/grub /etc/default/grub\.bak"
    "^cp /tmp/ro-control-.* /etc/"
    "^rm -f /etc/modprobe\.d/"
    "^rm -f /etc/X11/"
    "^rm -f /etc/modules-load\.d/"
    "^rm -f /etc/vulkan/"
    "^rm -f /usr/share/vulkan/"
    "^tee /etc/"
    "^timeshift "
    "^flatpak "
    "^prime-select (nvidia|intel|on-demand|query)$"
)

# Non-interactive mode for package managers
export DEBIAN_FRONTEND=noninteractive

# ─── Validate and execute each argument ──────────────────────────
for cmd in "$@"; do
    # Check for dangerous patterns
    for pattern in "${DANGEROUS_PATTERNS[@]}"; do
        if [[ "$cmd" == *"$pattern"* ]]; then
            printf 'SECURITY: Blocked dangerous character in: %s\n' "$cmd" >&2
            exit 126
        fi
    done

    # Check against allowlist
    cmd_allowed=false
    for pattern in "${ALLOWED_COMMANDS[@]}"; do
        if printf '%s\n' "$cmd" | grep -qE "$pattern"; then
            cmd_allowed=true
            break
        fi
    done

    if [ "$cmd_allowed" = false ]; then
        printf 'SECURITY: Blocked disallowed command: %s\n' "$cmd" >&2
        exit 126
    fi

    # Execute the validated command
    if ! /bin/sh -c "$cmd"; then
        printf 'ERROR: Command failed (exit %d): %s\n' "$?" "$cmd" >&2
        exit 1
    fi
done